<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/0.5.14/hls.min.js"></script>
    
	<!-- <script src="https://registry.npmmirror.com/xgplayer/3.0.18/files/dist/index.min.js"></script> -->
    <script src="//unpkg.byted-static.com/xgplayer/2.31.6/browser/index.js" charset="utf-8"></script>
    <script src="//unpkg.byted-static.com/xgplayer-hls.js/2.2.2/browser/index.js" charset="utf-8"></script>

    <link rel="stylesheet" href="https://registry.npmmirror.com/mdui/1/files/dist/css/mdui.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3U8 Video Player</title>
    <style>
    /* 为网格布局内的元素添加圆角效果 */
    .mdui-col > div, .mdui-col > a {
        border-radius: 10px;
        transition: transform .5s;
    }

    .mdui-col > div:hover {
        /* 渐变背景色 */
        background: linear-gradient(-45deg, #009688, #B2DFDB);
        color: white;
        transform: translateY(-5px);
    }
</style>
<script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
</head>
<body>
<div id = "info"></div>
<input type="text" id="textInput" placeholder="">
<button onclick="readInput()">refresh</button>
<div style="width: 100%; height:auto" id="video" ></div>
 <script>
    var urlParams = new URLSearchParams(window.location.search);

    // 使用 get() 方法获取指定参数的值
    let roomId = urlParams.get('roomid');
    console.log(roomId)
    if(roomId){
        refresh(roomId)
    }
    function readInput() {
    // 获取输入框的值
        var roomId = document.getElementById('textInput').value;
        refresh(roomId)
    }
    function refresh(roomId){
        console.log(roomId)
        $.ajax({
            url: "https://junlong.plus/ztool/live/bilibili/" + roomId,
            type: "get",
            dataType: "html",
            success: function(data){
                showData(data);
            },
            error: function(msg){
                alert("ajax连接异常："+msg);
            }
        });
    };

    function getLiveLink(data){
        let k = /url: '(.*?)'/
        let matches = data.match(k)
        return matches[1]
    }
    function getImgInfo(data){
        let k = /<div style="width: 100%;min-height: 100px;">[\d\D]*?<\/div>/
        let matches = data.match(k)
        console.log(matches)
        return matches[0]
    }
    function getUserName(data){
        let k = /<span.*?>(.*?)<\/span>/
        let matches = data.match(k)
        console.log(matches)
        return matches[1]
    }
    function getRoomTitle(data){
        let k = /<h6.*?>(.*?)<\/h6>/
        let matches = data.match(k)
        console.log(matches)
        return matches[1]
    }
    function showData(data) {
        var str = "";//定义用于拼接的字符串
        // console.log(data)
        liveLink = getLiveLink(data)
        divInfo = getImgInfo(data)
        userName = getUserName(divInfo)
        roomTitle = getRoomTitle(divInfo)
        document.title = userName + "-" + roomTitle

        document.getElementById('info').innerHTML = divInfo
        playhls(liveLink)
    }
    function playhls(url){
        var video = document.getElementById('video');
        var videoSrc = url;
        
        if (document.createElement('video').canPlayType('application/vnd.apple.mpegurl')) {
        // 原生支持 hls 播放
            let player = new Player({
                el: document.querySelector('#video'),
                isLive: true,
                url: videoSrc, // hls 流地址
            })
            console.log("support")
        }else{
            console.log("not support")
            
            let player = new HlsJsPlayer({
                "id": "video",
                "url": videoSrc,
                "playsinline": false,
                "whitelist": [
                        ""
                ],
                "autoplay": true
            });
            
                
        }
        // if (video.canPlayType('application/vnd.apple.mpegurl')) {
        //     video.src = videoSrc;
		// 		video.addEventListener('canplay', function () {
		// 	  video.play();
		// 	});
        // } else if (Hls.isSupported()) {
        //     var hls = new Hls();
        //     hls.loadSource(videoSrc);
        //     hls.attachMedia(video);
        // }
  }
</script>

<script>

</script>

</body>
</html>
